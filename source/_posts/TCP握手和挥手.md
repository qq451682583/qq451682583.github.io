---
title: TCP握手和挥手
comments: true
date: 2020-03-09 22:00:27
categories: 网络
tags: TCP
description:
---

[TOC]
<!--more-->

## 三次握手

先来了解一下三次握手。

在通过 TCP 传输数据时，第一步就是要先建立一个连接。TCP 建立连接的过程，就是我们常说的三次握手。

我们经常将三次握手，描述成「请求 → 应答 → 应答之应答」。

至于 TCP 握手为什么是三次，其实就是要让双端都经历一次「请求 → 应答」的过程，来确认对方还在。网络情况是多变的，双端都需要一次自己主动发起的请求和对方回复的应答过程，来确保对方和网络是正常的。

下面这张图，是比较经典的 TCP 三次握手的消息和双端状态的变化。

![8pHvJ1.png](https://s2.ax1x.com/2020/03/09/8pHvJ1.png)

我们先来解释一下这张图：

1. 在初始时，双端处于 CLOSE 状态，服务端为了提供服务，会主动监听某个端口，进入 LISTEN 状态。

2. 客户端主动发送连接的「SYN」包，之后进入 SYN-SENT 状态，服务端在收到客户端发来的「SYN」包后，回复「SYN,ACK」包，之后进入 SYN-RCVD 状态。

3. 客户端收到服务端发来的「SYN,ACK」包后，可以确认对方存在，此时回复「ACK」包，并进入 ESTABLISHED 状态。

4. 服务端收到最后一个「ACK」包后，也进入 ESTABLISHED 状态。

正常的三次握手之后，双端都进入 ESTABLISHED 状态，在此之后，就是正常的数据传输过程。

## 四次挥手

先来简单了解一下 TCP 的四次挥手。

当数据传输完成，需要断开连接的时候，TCP 会采取四次挥手的方式，来安全的断开连接。

为什么握手需要三次，而挥手需要四次呢？

本质上来说，双端都需要经过一次「分手」的过程，来保证自己和对端的状态正确。本着友好协商的态度，你先提出的分手，也要把最大的善意給对方，不能打了对方一个措手不及。你说不玩了就不玩了，那以后谁还敢和你玩。

下面这张图，是比较经典的 TCP 四次挥手的消息和双端状态的变化。

![8pqN4A.png](https://s2.ax1x.com/2020/03/09/8pqN4A.png)

我们解释一下这张图：

1. 初始时双端还都处于 ESTABLISHED 状态并传输数据，某端可以主动发起「FIN」包准备断开连接，在这里的场景下，是客户端发起「FIN」请求。在发出「FIN」后，客户端进入 FIN-WAIT-1 状态。

2. 服务端收到「FIN」消息后，回复「ACK」表示知道了，并从 ESTABLISHED 状态进入 CLOSED-WAIT 状态，开始做一些断开连接前的准备工作。

3. 客户端收到之前「FIN」的回复「ACK」消息后，进入 FIN-WAIT-2 状态。而当服务端做好断开前的准备工作后，也会发送一个「FIN,ACK」的消息給客户端，表示我也好了，请求断开连接，并在发送消息后，服务端进入 LAST-ACK 状态。

4. 客户端在收到「FIN,ACK」消息后，会立即回复「ACK」表示知道了，并进入 TIME_WAIT 状态，为了稳定和安全考虑，客户端会在 TIME-WAIT 状态等待 2MSL 的时长，最终进入 CLOSED 状态。

5. 服务端收到客户端回复的「ACK」消息后，直接从 LAST-ACK 状态进入 CLOSED 状态。

正常的经过四次挥手之后，双端都进入 CLOSED 状态，在此之后，双端正式断开了连接。

## TCP状态

在TCP层，有个FLAGS字段，这个字段有以下几个标识：SYN, FIN, ACK, PSH, RST, URG.

其中，对于我们日常的分析有用的就是前面的五个字段。

它们的含义是：


- SYN表示建立连接，

- FIN表示关闭连接，

- ACK表示响应，

- PSH表示有 DATA数据传输，

- RST表示连接重置。